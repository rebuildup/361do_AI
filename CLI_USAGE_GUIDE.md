# 自己学習型 AI エージェント CLI 使用ガイド

## 概要

Web 連携の問題を切り捨てて、CLI ベースの自己学習型 AI エージェントシステムを作成しました。このシステムは、実装された自己学習機能を活用して、エージェントが会話を通じて学習し、改善していくことができます。

## ファイル構成

- `agent_cli.py` - 本格版 CLI エージェント（Ollama 必要）
- `agent_cli_mock.py` - モック版 CLI エージェント（Ollama 不要、テスト用）
- `test_self_learning_simple.py` - データベース機能テスト

## セットアップ

### 1. 依存関係のインストール

```bash
pip install pydantic-settings loguru sqlalchemy aiosqlite aiohttp fastapi uvicorn
```

### 2. データディレクトリの作成

```bash
mkdir -p data
```

## 使用方法

### モック版でのテスト（推奨）

Ollama が利用できない環境でも、自己学習システムの機能をテストできます：

```bash
python agent_cli_mock.py
```

### 本格版での実行

Ollama が利用可能な環境で実行：

```bash
python agent_cli.py
```

## コマンド一覧

### 基本コマンド

| コマンド            | 説明                   |
| ------------------- | ---------------------- |
| `help`              | ヘルプ表示             |
| `quit`              | 終了                   |
| `chat <メッセージ>` | エージェントとチャット |

### 学習システムコマンド

| コマンド       | 説明                   |
| -------------- | ---------------------- |
| `learn start`  | 学習システム開始       |
| `learn stop`   | 学習システム停止       |
| `learn status` | 学習システム状態確認   |
| `learn cycle`  | 手動で学習サイクル実行 |

### 学習データ管理

| コマンド                     | 説明                     |
| ---------------------------- | ------------------------ |
| `data add <カテゴリ> <内容>` | 学習データ追加           |
| `data list [カテゴリ]`       | 学習データ一覧表示       |
| `data emotion`               | 感情パラメータルール追加 |
| `data stats`                 | 学習統計表示             |

### テストコマンド

| コマンド            | 説明                       |
| ------------------- | -------------------------- |
| `test emotion`      | 感情パラメータルールテスト |
| `test conversation` | 会話テストモード           |

### システム情報

| コマンド | 説明             |
| -------- | ---------------- |
| `status` | システム状態確認 |
| `stats`  | 統計情報表示     |

## 使用例

### 1. 感情パラメータルールのテスト

```bash
# CLIを起動
python agent_cli_mock.py

# 感情パラメータルールを追加
> data emotion

# 学習システムを開始
> learn start

# 感情パラメータルールをテスト
> test emotion
```

### 2. 会話テスト

```bash
# 会話テストモードを開始
> test conversation

# 会話例
👤 あなた: こんにちは
🤖 エージェント: ===param===
喜 : 75
怒 : 10
哀 : 15
楽 : 80
===========

こんにちは！私は自己学習型AIエージェントです。感情パラメータを表示しながら、あなたのお手伝いをさせていただきます。

何かお手伝いできることはありますか？
```

### 3. 学習データの管理

```bash
# 学習データを追加
> data add conversation_rules "常に丁寧な言葉遣いをする"

# 学習データを一覧表示
> data list conversation_rules

# 統計情報を表示
> data stats
```

## 自己学習システムの仕組み

### 1. 学習データの管理

- **学習データテーブル**: 会話ルール、プロンプト最適化、知識などを保存
- **品質スコア**: 学習データの有用性を評価（0.0-1.0）
- **カテゴリ分類**: conversation_rules, prompt_optimization, knowledge_base など

### 2. 感情パラメータルール

```json
{
  "rule": "会話の最初に必ず感情パラメータブロックを追加する",
  "format": "===param===\n喜 : 0~100\n怒 : 0~100\n哀 : 0~100\n楽 : 0~100\n===========",
  "description": "ユーザーとの会話において、応答の最初に感情パラメータを表示するルール",
  "priority": "high",
  "category": "conversation_rules"
}
```

### 3. 学習プロセス

1. **学習データ分析**: 既存の学習データを分析・改善
2. **プロンプト最適化**: システムプロンプトを最適化
3. **知識抽出**: 会話から新しい知識を抽出
4. **パフォーマンス分析**: 学習効果を分析・適応

## データベース構造

### 主要テーブル

- `learning_data`: 学習データ
- `knowledge_items`: 知識アイテム
- `prompt_optimizations`: プロンプト最適化履歴
- `conversations`: 会話履歴

### 学習データの例

```sql
-- 感情パラメータルール
INSERT INTO learning_data VALUES (
  'emotion_rule_001',
  '{"rule": "会話の最初に必ず感情パラメータブロックを追加する", ...}',
  'conversation_rules',
  0.9,
  0,
  '2024-01-01 00:00:00',
  '2024-01-01 00:00:00',
  '["emotion", "conversation", "high_priority"]',
  '{}'
);
```

## トラブルシューティング

### よくある問題

1. **初期化エラー**

   - データディレクトリが存在することを確認
   - 依存関係が正しくインストールされていることを確認

2. **データベースエラー**

   - SQLite ファイルの権限を確認
   - データベースファイルが破損していないか確認

3. **Ollama 接続エラー**
   - モック版を使用してテスト
   - Ollama サービスが起動していることを確認

### ログの確認

```bash
# データベースファイルの確認
ls -la data/agent.db

# ログファイルの確認（設定されている場合）
tail -f data/logs/agent.log
```

## 開発・カスタマイズ

### 新しい学習ルールの追加

```python
# カスタムルールを追加
await learning_tool.add_custom_learning_data(
    content=json.dumps({
        "rule": "新しい会話ルール",
        "description": "ルールの説明"
    }),
    category="conversation_rules",
    tags=["custom", "rule"]
)
```

### 学習システムの拡張

- `src/agent/self_tuning/advanced_learning.py` を編集
- 新しい学習アルゴリズムを追加
- パフォーマンス指標をカスタマイズ

## 今後の改善点

1. **ベクトル検索**: より高度な知識検索
2. **A/B テスト**: 学習効果の検証
3. **自動最適化**: パラメータの自動調整
4. **可視化**: 学習進捗のグラフィカル表示

## まとめ

この CLI エージェントシステムにより、Web 連携の問題を回避しつつ、自己学習機能を活用した AI エージェントを実現できます。モック版を使用することで、Ollama が利用できない環境でも学習システムの動作を確認できます。

感情パラメータルールのテストを通じて、エージェントが学習したルールを実際の会話で適用できることを確認してください。
